@model FacturacionElectronicaSV.ViewModels.FacturaViewModel
@{
    ViewData["Title"] = "Crear Factura";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

<style>
    body {
        background: linear-gradient(to right, #007bff, #00c6ff);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', sans-serif;
    }

    .factura-card {
        width: 100%;
        max-width: 1000px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
        animation: fadeIn 0.8s ease-in-out;
        background-color: white;
        padding: 30px;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .factura-header {
        background-color: #004080;
        color: white;
        text-align: center;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }

    .form-label {
        font-weight: 600;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .btn-generar:hover {
        transform: scale(1.03);
    }

    .text-danger {
        font-size: 0.85rem;
    }
</style>

<div class="factura-card">
    <div class="factura-header">
        <img src="~/images/logo-digifactura.png" alt="Logo DigiFactura SV" width="60" class="mb-2" />
        <h4 class="mb-0">DigiFactura SV</h4>
        <small>Creación de Documento Tributario Electrónico</small>
    </div>

    <form asp-action="Crear" method="post" class="mt-4">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="IdCliente" class="form-label">Cliente</label>
                <select asp-for="IdCliente" asp-items="@(new SelectList(ViewBag.Clientes, "IdReceptor", "Nombre"))" class="form-select"></select>
                <span asp-validation-for="IdCliente" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="FormaPago" class="form-label">Forma de Pago</label>
                <select asp-for="FormaPago" class="form-select">
                    @foreach (var fp in ViewBag.FormasPago)
                    {
                        <option value="@fp.Codigo">@fp.Nombre</option>
                    }
                </select>
                <span asp-validation-for="FormaPago" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="NumeroControl" class="form-label">Número de Control</label>
                <input asp-for="NumeroControl" class="form-control" />
                <span asp-validation-for="NumeroControl" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="SubTotal" class="form-label">Subtotal</label>
                <input asp-for="SubTotal" class="form-control" />
                <span asp-validation-for="SubTotal" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="TotalGravada" class="form-label">Total Gravada</label>
                <input asp-for="TotalGravada" class="form-control" />
                <span asp-validation-for="TotalGravada" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="TotalIVA" class="form-label">Total IVA</label>
                <input asp-for="TotalIVA" class="form-control" />
                <span asp-validation-for="TotalIVA" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="TotalPagar" class="form-label">Total a Pagar</label>
                <input asp-for="TotalPagar" class="form-control" />
                <span asp-validation-for="TotalPagar" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="TotalLetras" class="form-label">Total en Letras</label>
                <input asp-for="TotalLetras" class="form-control" />
                <span asp-validation-for="TotalLetras" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="Contrasena" class="form-label">Contraseña</label>
                <input asp-for="Contrasena" type="password" class="form-control" />
                <span asp-validation-for="Contrasena" class="text-danger"></span>
            </div>
        </div>

        <h5 class="mt-4">Detalle de Factura</h5>
        <table class="table table-bordered table-sm" id="tablaDetalles">
            <thead class="table-light">
                <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Venta Gravada</th>
                    <th>IVA</th>
                    <th>Tipo Item</th>
                    <th>Unidad Medida</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="text-end mb-3">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregarItem">
                <i class="fas fa-plus-circle"></i> Agregar ítem
            </button>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-generar px-5">Crear DTE</button>
        </div>
    </form>
</div>

<!-- Modal flotante para agregar ítem -->
<div class="modal fade" id="modalAgregarItem" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalLabel">Adición detalle de DTE</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <input type="text" class="form-control" value="1 - Bien" readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="cantidad" required />
                        <small class="text-danger d-none" id="valCantidad">Requerido.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unidad</label>
                        <input type="text" class="form-control" id="unidadMedida" required />
                        <small class="text-danger d-none" id="valUnidad">Requerido.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nombre Producto</label>
                        <input type="text" class="form-control" id="descripcion" required />
                        <small class="text-danger d-none" id="valDescripcion">Requerido.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo Venta</label>
                        <input type="text" class="form-control" value="Gravado" readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Precio</label>
                        <input type="number" class="form-control" id="precioUnitario" required />
                    </div>
                </div>

                <hr class="my-4" />
                <h6>Información de los tributos</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Impuesto</label>
                        <select class="form-select" id="impuesto">
                            <option value="13">20 - Impuesto al Valor Agregado 13%</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Descuento</label>
                        <input type="number" class="form-control" id="descuento" value="0" />
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <strong>Total: $<span id="totalCalculado">0.00</span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="btnConfirmarItem">Agregar ítem</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById("btnConfirmarItem").addEventListener("click", function () {
        const cantidad = document.getElementById("cantidad").value.trim();
        const unidad = document.getElementById("unidadMedida").value.trim();
        const descripcion = document.getElementById("descripcion").value.trim();
        const precio = parseFloat(document.getElementById("precioUnitario").value) || 0;
        const descuento = parseFloat(document.getElementById("descuento").value) || 0;
        const impuesto = parseFloat(document.getElementById("impuesto").value) || 0;

        // Validaciones visuales
        document.getElementById("valCantidad").classList.toggle("d-none", cantidad !== "");
        document.getElementById("valUnidad").classList.toggle("d-none", unidad !== "");
        document.getElementById("valDescripcion").classList.toggle("d-none", descripcion !== "");

        if (!cantidad || !unidad || !descripcion) return;

        const ventaGravada = precio * cantidad;
        const iva = ventaGravada * (impuesto / 100);
        const total = ventaGravada - descuento + iva;

        document.getElementById("totalCalculado").textContent = total.toFixed(2);

        const tabla = document.getElementById("tablaDetalles").getElementsByTagName("tbody")[0];
        const fila = tabla.insertRow();
        fila.innerHTML = `
            <td><input name="Detalles[0].Codigo" class="form-control form-control-sm" value="AUTO" readonly /></td>
            <td><input name="Detalles[0].Descripcion" class="form-control form-control-sm" value="${descripcion}" /></td>
            <td><input name="Detalles[0].Cantidad" class="form-control form-control-sm" value="${cantidad}" /></td>
            <td><input name="Detalles[0].PrecioUnitario" class="form-control form-control-sm" value="${precio}" /></td>
            <td><input name="Detalles[0].VentaGravada" class="form-control form-control-sm" value="${ventaGravada.toFixed(2)}" /></td>
            <td><input name="Detalles[0].IVA" class="form-control form-control-sm" value="${iva.toFixed(2)}" /></td>
            <td><input name="Detalles[0].TipoItem" class="form-control form-control-sm" value="Bien" /></td>
            <td><input name="Detalles[0].UnidadMedida" class="form-control form-control-sm" value="${unidad}" /></td>
        `;

        // Reset y cerrar
        document.querySelectorAll("#modalAgregarItem input").forEach(i => i.value = "");
        document.getElementById("descuento").value = "0";
        document.getElementById("totalCalculado").textContent = "0.00";
        bootstrap.Modal.getInstance(document.getElementById("modalAgregarItem")).hide();
    });
</script>
